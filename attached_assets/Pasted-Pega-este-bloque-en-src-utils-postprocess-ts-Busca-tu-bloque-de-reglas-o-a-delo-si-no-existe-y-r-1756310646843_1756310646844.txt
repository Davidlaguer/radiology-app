Pega este bloque en src/utils/postprocess.ts

Busca tu bloque de reglas (o añádelo si no existe) y reemplázalo por este. Está pensado para trabajar con tu pipeline actual (modo plantilla activado al detectar “Valida frases normales.”):

// ===============================
// 1) TRIGGERS para anular frases normales por contradicción
// ===============================

// Cada regla: si alguna línea del informe (ya parseada) hace match con cualquier regex de triggers,
// eliminamos la frase normal objetivo.
const DROP_NORMAL_RULES: Array<{
  normalText: RegExp;      // identifica la línea normal (texto exacto o patrón estable)
  triggers: RegExp[];      // uno o varios patrones que, si aparecen en hallazgos, invalidan la normal
}> = [
  // ---- TÓRAX ----
  {
    // Parénquima sano / sin nódulos → cae ante patrones parenquimatosos o nódulos
    normalText: /^Par[eé]nquima pulmonar sin alteraciones a destacar\.\s*No se observan condensaciones de espacio a[eé]reo ni n[oó]dulos pulmonares\.$/i,
    triggers: [
      /\b(opacidad|opacidades|consolidaci[oó]n|condensaci[oó]n|vidrio (deslustrado|esmerilado)|reticulaci[oó]n|engrosamientos? septales?|n[oó]dulo[s]?)\b/i
    ]
  },
  {
    // Pleura libre → cae ante cualquier derrame / neumotórax / hidroneumotórax
    normalText: /^Espacios pleurales libres\.$/i,
    triggers: [
      /\bderrame pleural\b/i,
      /\bneumot[oó]rax\b/i,
      /\bhidroneumot[oó]rax\b/i
    ]
  },
  {
    // Axilares normales → cae si hay adenopatía axilar
    normalText: /^No se observan adenopat[ií]as supraclaviculares o axilares aumentadas de tama[nñ]o\.$/i,
    triggers: [
      /\badenopat[ií]a(s)?.*axilar(es)?.*\b\d{1,3}\s?mm\b/i,
      /\badenopat[ií]a(s)?.*axilar(es)?\b/i
    ]
  },

  // ---- ABDOMEN: HÍGADO ----
  {
    // Lesiones focales hepáticas → si hay quistes/hemangiomas, se reconvierte a "No se observan OTRAS..."
    // La eliminación en sí la hacemos en la fase de "convertToOtras"; aquí no la borramos.
    normalText: /^No se observan lesiones focales hep[aá]ticas\.$/i,
    triggers: [
      /\b(hemangioma(s)?|quistes? hep[aá]ticos?|lesi[oó]n( es)? focal(es)? hep[aá]tica(s)?)\b/i
    ]
  },

  // ---- ABDOMEN: VESÍCULA ----
  {
    normalText: /^Ves[ií]cula biliar sin evidencia de litiasis en su interior, engrosamientos murales o signos inflamatorios agudos\.$/i,
    triggers: [
      /\b(colelitiasis|barro biliar|sludge)\b/i,
      /\b(colecistitis( aguda)?)\b/i,
      /\b(engrosamiento mural vesicular|pared vesicular engrosada)\b/i,
      /\bl[ií]quido perivesicular\b/i
    ]
  },

  // ---- ABDOMEN: VÍAS URINARIAS ----
  // Negativas globales por lado (si tu plantilla usa 2 líneas por lado, explícitalas así)
  {
    normalText: /^No se observan lesiones focales ni dilataci[oó]n de la v[ií]a urinaria derecha\.$/i,
    triggers: [
      // Cualquier hallazgo urológico en lado derecho
      /\b(micro)?litiasis( renal)? (derecha|en ri[nñ][oó]n derecho)\b/i,
      /\bureterohidronefrosis( derecha)?\b/i,
      /\b(ectasia|dilataci[oó]n) (pielo|pieloureteral|de pelvis y ur[eé]ter).*(derecha|derecho)\b/i,
      /\bengrosamiento urotelial\b.*(derecho|derecha)/i,
      /\btumor (de )?v[ií]as\b.*(derecho|derecha)/i
    ]
  },
  {
    normalText: /^No se observan lesiones focales ni dilataci[oó]n de la v[ií]a urinaria izquierda\.$/i,
    triggers: [
      /\b(micro)?litiasis( renal)? (izquierda|en ri[nñ][oó]n izquierdo)\b/i,
      /\bureterohidronefrosis( izquierda)?\b/i,
      /\b(ectasia|dilataci[oó]n) (pielo|pieloureteral|de pelvis y ur[eé]ter).*(izquierda|izquierdo)\b/i,
      /\bengrosamiento urotelial\b.*(izquierdo|izquierda)/i,
      /\btumor (de )?v[ií]as\b.*(izquierdo|izquierda)/i
    ]
  },
  // Si tu plantilla tiene una sola línea global:
  {
    normalText: /^No se observan lesiones focales ni dilataci[oó]n de las v[ií]as urinarias\.$/i,
    triggers: [
      /\b(micro)?litiasis( renal)?\b/i,
      /\bureterohidronefrosis\b/i,
      /\b(ectasia|dilataci[oó]n) (pielo|pieloureteral|de pelvis y ur[eé]ter)\b/i,
      /\bengrosamiento urotelial\b/i,
      /\btumor (de )?v[ií]as\b/i
    ]
  },

  // ---- ABDOMEN: ADENOPATÍAS ----
  {
    normalText: /^No se observan adenopat[ií]as intraabdominales aumentadas de tama[nñ]o\.$/i,
    triggers: [
      /\badenopat[ií]a(s)?\b.*\b\d{1,3}\s?mm\b/i,
      /\badenopat[ií]a(s)? (retroperitoneales?|paraa[oó]rticas?|mesent[eé]ricas?|iliacas?|p[eé]lvicas?)\b/i
    ]
  },

  // ---- PERITONEO ----
  {
    normalText: /^No se observan colecciones, neumoperitoneo ni l[ií]quido libre intraabdominal\.$/i,
    triggers: [
      /\bcolecci[oó]n( es)?( intraabdominal(es)?)?\b/i,
      /\b(absceso|neumoperitoneo|ascitis|carcinomatosis peritoneal)\b/i
    ]
  }
];

// ===============================
// 2) Conversión “No se observan lesiones focales hepáticas” → “No se observan OTRAS…”
// ===============================
function convertHepaticNegativesWhenFocalPresent(lines: string[]): string[] {
  const hasFocal = lines.some(l =>
    /\b(hemangioma(s)?|quistes? hep[aá]ticos?|lesi[oó]n( es)? focal(es)? hep[aá]tica(s)?)\b/i.test(l)
  );
  if (!hasFocal) return lines;
  return lines.map(l =>
    /^No se observan lesiones focales hep[aá]ticas\.$/i.test(l)
      ? 'No se observan otras lesiones focales hepáticas.'
      : l
  );
}

// ===============================
// 3) Clasificación por secciones (bucket sort orden anatómico)
// ===============================
const SECTION_ORDER = [
  // Tórax
  'thorax.mediastino',
  'thorax.vascular',
  'thorax.parenquima',
  'thorax.pleura',
  'thorax.cuello_axila',
  // Abdomen
  'abd.hepatobiliar.higado',
  'abd.hepatobiliar.vias_vesicula',
  'abd.bazo',
  'abd.pancreas',
  'abd.suprarrenal',
  'abd.renal_uro',
  'abd.ganglionar',
  'abd.peritoneo_mesenterio',
  // cierre
  'misc'
] as const;

type SectionKey = typeof SECTION_ORDER[number];

function classifyLine(line: string): SectionKey {
  const s = line.toLowerCase();

  // Tórax
  if (/mediast[ií]n|paratraqueal|subcarinal|hiliar(es)?|adenopat[ií]a(s)? mediast/i.test(s)) return 'thorax.mediastino';
  if (/arteria pulmonar|tep\b|tromboembolismo/i.test(s)) return 'thorax.vascular';
  if (/par[eé]nquima|n[oó]dulo|opacidad|consolidaci[oó]n|vidrio|reticulaci[oó]n|septal/i.test(s)) return 'thorax.parenquima';
  if (/pleural|derrame|neumot[ió]rax|hidroneumot/i.test(s)) return 'thorax.pleura';
  if (/tiroid|bocio|axilar(es)?|supraclavicular(es)?/i.test(s)) return 'thorax.cuello_axila';

  // Abdomen
  if (/h[ií]gado|hep[aá]tico|segmento [ivx]+/i.test(s)) return 'abd.hepatobiliar.higado';
  if (/ves[ií]cula|biliar|coledoc|barro biliar|colelitiasis|colangitis/i.test(s)) return 'abd.hepatobiliar.vias_vesicula';
  if (/\bbazo|espl[eé]n/i.test(s)) return 'abd.bazo';
  if (/p[aá]ncreas|wirsung|ipmn|tpm/i.test(s)) return 'abd.pancreas';
  if (/suprarrenal|adrenal|feocromocitoma|mielolipoma/i.test(s)) return 'abd.suprarrenal';
  if (/ri[nñ][oó]n|renal|pelvis extrarrenal|pielo|ureter|urotelial|hidro(nefro|uretero)nefrosis|litiasis|microlitiasis/i.test(s)) return 'abd.renal_uro';
  if (/adenopat[ií]a(s)? (retro|mesent|para?a[oó]rt|p[eé]lv|inguin|iliac)/i.test(s)) return 'abd.ganglionar';
  if (/peritoneo|mesenter|carcinomatosis|ascitis|colecci[oó]n|neumoperitoneo|trabeculaci[oó]n/i.test(s)) return 'abd.peritoneo_mesenterio';

  return 'misc';
}

function orderBySections(lines: string[]): string[] {
  const buckets = new Map<SectionKey, string[]>();
  SECTION_ORDER.forEach(k => buckets.set(k, []));
  for (const l of lines) buckets.get(classifyLine(l))!.push(l);
  return SECTION_ORDER.flatMap(k => buckets.get(k)!);
}

// ===============================
// 4) Aplicación de reglas en modo plantilla
// ===============================
export function applyPostprocessNorms(
  lines: string[],
  opts: { templateMode?: boolean } = {}
): string[] {
  let out = [...lines];

  // 4.1 Conversión hepática si hay focales
  out = convertHepaticNegativesWhenFocalPresent(out);

  // 4.2 Si ‘templateMode’, quitar normales contradictorias
  if (opts.templateMode) {
    const joined = out.join(' \n ');
    out = out.filter(normalLine => {
      const rule = DROP_NORMAL_RULES.find(r => r.normalText.test(normalLine));
      if (!rule) return true;
      return !rule.triggers.some(rx => rx.test(joined));
    });
  }

  // 4.3 Orden anatómico estable por secciones
  out = orderBySections(out);

  // 4.4 Consolidaciones menores opcionales (puntos finales, espacios, duplicados simples)
  out = dedupeKeepOrder(out).map(ensureDot);

  return out;
}

// Utils pequeños (si no los tienes ya en este archivo)
function ensureDot(s: string): string {
  const t = s.trim();
  if (!t) return t;
  return /[.:]$/.test(t) ? t : `${t}.`;
}
function dedupeKeepOrder(arr: string[]): string[] {
  const seen = new Set<string>();
  const res: string[] = [];
  for (const x of arr) if (!seen.has(x)) { seen.add(x); res.push(x); }
  return res;
}


Nota: si ya tienes applyPostprocessNorms declarado, sustituye su contenido por el de arriba (respetando tus imports auxiliares si los usas). Si tu plantilla renal usa dos líneas negativas separadas (derecha/izquierda) como en tus ejemplos, este bloque ya lo contempla. Si en algún preset tienes la línea única (“las vías urinarias”), también la contempla.